{% extends "base.html" %}

{% block title %}{{ broker.name }}{% endblock %}
{% block header_title %}{{ broker.name }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <a href="{{ url_for('brokers_list') }}" class="text-secondary" style="font-size: 0.875rem;">← Volver a
            Brokers</a>
        <h2 style="margin-top: 0.5rem;">{{ broker.name }}</h2>
    </div>
    <a href="{{ url_for('broker_edit', broker_id=broker.id) }}" class="btn btn-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
        Editar
    </a>
</div>

<div class="grid-2">
    <!-- Broker Info Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Informacion del Broker</h3>
        </div>
        <div class="card-body">
            <div class="broker-header mb-3">
                <div class="broker-logo" style="width: 72px; height: 72px; font-size: 1.75rem;">{{ broker.name[0] }}
                </div>
                <div class="broker-info">
                    <h3 style="font-size: 1.5rem;">{{ broker.name }}</h3>
                    <div class="star-rating-display" style="font-size: 1.5rem;">
                        <span class="stars">
                            {% for i in range(5) %}
                            {% if i < broker.average_rating|int %}★{% else %}☆{% endif %} {% endfor %} </span>
                                <span class="count" style="font-size: 1rem;">({{ "%.1f"|format(broker.average_rating) }}
                                    promedio)</span>
                    </div>
                </div>
            </div>

            {% if broker.description %}
            <p class="mb-3">{{ broker.description }}</p>
            {% endif %}

            <div class="grid-2" style="gap: 1rem;">
                {% if broker.website %}
                <div>
                    <strong class="text-muted" style="font-size: 0.75rem; text-transform: uppercase;">Sitio Web</strong>
                    <p><a href="{{ broker.website }}" target="_blank">{{ broker.website }}</a></p>
                </div>
                {% endif %}

                {% if broker.email %}
                <div>
                    <strong class="text-muted" style="font-size: 0.75rem; text-transform: uppercase;">Email</strong>
                    <p><a href="mailto:{{ broker.email }}">{{ broker.email }}</a></p>
                </div>
                {% endif %}

                {% if broker.phone %}
                <div>
                    <strong class="text-muted" style="font-size: 0.75rem; text-transform: uppercase;">Telefono</strong>
                    <p>{{ broker.phone }}</p>
                </div>
                {% endif %}

                <div>
                    <strong class="text-muted" style="font-size: 0.75rem; text-transform: uppercase;">Comision</strong>
                    <p><span class="badge badge-warning">{{ broker.commission_rate }}%</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Ratings Overview -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Puntuaciones por Categoria</h3>
        </div>
        <div class="card-body">
            {% set category_ratings = broker.get_all_category_ratings() %}
            {% for cat_id, cat_data in category_ratings.items() %}
            <div class="rating-category-row"
                style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                <div>
                    <strong>{{ cat_data.name }}</strong>
                    <span class="text-muted" style="font-size: 0.75rem; margin-left: 0.5rem;">({{ cat_data.count }}
                        votos)</span>
                </div>
                <div class="star-rating-display">
                    <span class="stars" style="color: var(--warning-color);">
                        {% for i in range(5) %}
                        {% if i < cat_data.average|int %}★{% else %}☆{% endif %} {% endfor %} </span>
                            <span class="text-secondary"
                                style="font-size: 0.875rem; min-width: 40px; text-align: right;">
                                {{ "%.1f"|format(cat_data.average) if cat_data.average > 0 else "-" }}
                            </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- User Rating Section -->
<div class="card mt-3">
    <div class="card-header">
        <h3 class="card-title">Tu Puntuacion</h3>
        <span class="text-secondary" style="font-size: 0.875rem;">Califica este broker en cada categoria</span>
    </div>
    <div class="card-body">
        {% set user_ratings = broker.get_user_ratings(current_user.id) %}
        <form method="POST" action="{{ url_for('broker_rate', broker_id=broker.id) }}">
            <div class="rating-categories-grid"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                {% for cat_id, cat_name in broker.RATING_CATEGORIES %}
                <div class="rating-category-card"
                    style="background: var(--bg-secondary); padding: 1.25rem; border-radius: var(--radius-md);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <strong>{{ cat_name }}</strong>
                        {% if user_ratings.get(cat_id) %}
                        <span class="badge badge-success">Votado</span>
                        {% endif %}
                    </div>

                    <div class="star-rating" style="font-size: 1.75rem; margin-bottom: 0.5rem;"
                        data-category="{{ cat_id }}">
                        {% for i in range(1, 6) %}
                        <span class="star {% if user_ratings.get(cat_id, 0) >= i %}active{% endif %}"
                            data-value="{{ i }}">★</span>
                        {% endfor %}
                        <input type="hidden" name="rating_{{ cat_id }}" value="{{ user_ratings.get(cat_id, 0) }}">
                    </div>
                </div>
                {% endfor %}
            </div>

            <div style="margin-top: 1.5rem; display: flex; justify-content: center;">
                <button type="submit" class="btn btn-primary" style="padding: 0.75rem 3rem; font-size: 1rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2"
                        style="display: inline; margin-right: 8px; vertical-align: middle;">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Guardar Todas las Puntuaciones
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Messages Section -->
<div class="card mt-3">
    <div class="card-header">
        <h3 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2"
                style="display: inline; margin-right: 8px; vertical-align: middle;">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            Comentarios
        </h3>
    </div>
    <div class="card-body">
        <!-- Add Message Form -->
        <form method="POST" action="{{ url_for('broker_message', broker_id=broker.id) }}" class="mb-3">
            <div class="form-group mb-2">
                <textarea class="form-control" name="content" placeholder="Escribe un comentario sobre este broker..."
                    rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
                </svg>
                Enviar Comentario
            </button>
        </form>

        <!-- Messages List -->
        {% if messages %}
        <div class="message-list">
            {% for msg in messages %}
            <div class="message-item">
                <div class="message-avatar">{{ msg.author.full_name[0] if msg.author.full_name else
                    msg.author.username[0]|upper }}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">{{ msg.author.full_name or msg.author.username }}</span>
                        <span class="message-time">{{ msg.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                    </div>
                    <p class="message-text">{{ msg.content }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state" style="padding: 2rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1.5">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <h3>Sin comentarios</h3>
            <p>Se el primero en dejar un comentario</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Interactive star rating for all categories
    document.querySelectorAll('.star-rating').forEach(ratingGroup => {
        const stars = ratingGroup.querySelectorAll('.star');
        const category = ratingGroup.dataset.category;
        const input = ratingGroup.querySelector(`input[name="rating_${category}"]`);

        stars.forEach(star => {
            star.addEventListener('click', function () {
                const value = parseInt(this.dataset.value);
                input.value = value;

                stars.forEach((s, idx) => {
                    s.classList.toggle('active', idx < value);
                });
            });

            star.addEventListener('mouseover', function () {
                const value = parseInt(this.dataset.value);

                stars.forEach((s, idx) => {
                    s.style.color = idx < value ? '#f59e0b' : '#e2e8f0';
                });
            });

            star.addEventListener('mouseout', function () {
                const currentValue = parseInt(input.value) || 0;

                stars.forEach((s, idx) => {
                    s.style.color = '';
                    s.classList.toggle('active', idx < currentValue);
                });
            });
        });
    });
</script>
{% endblock %}